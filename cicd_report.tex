\documentclass[12pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[vietnamese]{babel}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{geometry}
\usepackage{hyperref}
\usepackage{fancyhdr}
\usepackage{titlesec}

\geometry{margin=2.5cm}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{BÃ¡o cÃ¡o thá»±c táº­p}
\fancyhead[R]{AIESEC Dashboard CI/CD}
\fancyfoot[C]{\thepage}

% Cáº¥u hÃ¬nh cho code blocks
\lstset{
    language=bash,
    basicstyle=\ttfamily\small,
    keywordstyle=\color{blue},
    commentstyle=\color{gray},
    stringstyle=\color{red},
    numbers=left,
    numberstyle=\tiny,
    stepnumber=1,
    numbersep=5pt,
    backgroundcolor=\color{gray!10},
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    frame=single,
    tabsize=2,
    captionpos=b,
    breaklines=true,
    breakatwhitespace=false,
    escapeinside={\%*}{*)}
}

\title{\textbf{CHÆ¯Æ NG 4: TRIá»‚N KHAI Há»† THá»NG CI/CD}}
\author{}
\date{}

\begin{document}

\maketitle

\section{Quy trÃ¬nh láº¯p Ä‘áº·t há»‡ Ä‘iá»u hÃ nh vÃ  deploy lÃªn VPS}

Má»¥c tiÃªu cá»§a pháº§n nÃ y lÃ  mÃ´ táº£ Ä‘áº§y Ä‘á»§ cÃ¡c bÆ°á»›c tá»« má»™t VPS ``tráº¯ng'' (chá»‰ cÃ³ SSH) tá»›i khi á»©ng dá»¥ng Next.js cháº¡y á»•n Ä‘á»‹nh kÃ¨m cÆ¡ sá»Ÿ dá»¯ liá»‡u MySQL vÃ  giao diá»‡n quáº£n trá»‹ Adminer. CÃ¡c bÆ°á»›c Ã¡p dá»¥ng trÃªn Ubuntu 22.04 LTS.

\subsection{Khá»Ÿi táº¡o vÃ  báº£o máº­t cÆ¡ báº£n}

\begin{lstlisting}[caption=Cáº­p nháº­t há»‡ thá»‘ng vÃ  táº¡o user quáº£n trá»‹]
# Cáº­p nháº­t OS
sudo apt update && sudo apt upgrade -y

# Táº¡o user má»›i (vÃ­ dá»¥: deploy)
sudo adduser deploy
sudo usermod -aG sudo deploy

# KÃ­ch hoáº¡t firewall cÆ¡ báº£n
sudo apt install ufw -y
sudo ufw allow OpenSSH
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
sudo ufw status
\end{lstlisting}

\subsection{Cáº¥u hÃ¬nh SSH key-based login}

\begin{enumerate}
  \item Táº¡o SSH key trÃªn mÃ¡y Windows (PowerShell):
\begin{lstlisting}
ssh-keygen -t ed25519 -C "email@domain"  # sinh C:\\Users\\YOU\\.ssh\\id_ed25519(.pub)
\end{lstlisting}
  \item DÃ¡n public key vÃ o VPS cho user \texttt{deploy}:
\begin{lstlisting}
sudo -u deploy mkdir -p /home/deploy/.ssh
sudo nano /home/deploy/.ssh/authorized_keys  # dÃ¡n ná»™i dung id_ed25519.pub
sudo chown -R deploy:deploy /home/deploy/.ssh
sudo chmod 700 /home/deploy/.ssh
sudo chmod 600 /home/deploy/.ssh/authorized_keys
sudo chmod 755 /home /home/deploy
\end{lstlisting}
  \item Chá»‰nh \texttt{/etc/ssh/sshd\_config} (tÃ¹y chá»n, tÄƒng báº£o máº­t):
\begin{lstlisting}
PubkeyAuthentication yes
PasswordAuthentication no
PermitRootLogin prohibit-password
AuthorizedKeysFile .ssh/authorized_keys
\end{lstlisting}
  \item Khá»Ÿi Ä‘á»™ng láº¡i SSH:
\begin{lstlisting}
sudo systemctl reload ssh
\end{lstlisting}
\end{enumerate}

\subsection{CÃ i Ä‘áº·t Node.js, PM2, Git}

\begin{lstlisting}[caption=CÃ i Node.js LTS, PM2, Git]
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt install -y nodejs git

sudo npm i -g pm2
pm2 --version
git --version
node -v && npm -v
\end{lstlisting}

\subsection{Triá»ƒn khai á»©ng dá»¥ng Next.js vá»›i PM2}

\begin{lstlisting}[caption=Clone mÃ£ nguá»“n vÃ  cháº¡y báº±ng PM2]
sudo mkdir -p /root/apps/aiv-dashboard
sudo chown -R $USER:$USER /root/apps/aiv-dashboard || true
cd /root/apps/aiv-dashboard

# Clone (hoáº·c scp) project
git clone https://github.com/your-org/aiv-dashboard.git .

# CÃ i dependencies vÃ  build
npm ci
npm run build

# Táº¡o ecosystem PM2
cat > ecosystem.config.js <<'EOF'
module.exports = {
  apps: [{
    name: 'aiv-dashboard',
    script: 'npm',
    args: 'run start -- -p 3000 -H 0.0.0.0',
    cwd: '/root/apps/aiv-dashboard',
    env_file: '.env'
  }]
}
EOF

# Táº¡o file .env theo á»©ng dá»¥ng
cat > .env <<'EOF'
DATABASE_HOST=127.0.0.1
DATABASE_PORT=3306
DATABASE_USER=root
DATABASE_PASSWORD=yourStrongPass
DATABASE_NAME=aivdb
DATABASE_SSL=false
EOF

# Khá»Ÿi cháº¡y báº±ng PM2
pm2 start ecosystem.config.js
pm2 save
pm2 startup  # Thiáº¿t láº­p tá»± khá»Ÿi Ä‘á»™ng cÃ¹ng há»‡ thá»‘ng
\end{lstlisting}

\subsection{CÃ i Ä‘áº·t MySQL vÃ  táº¡o cÆ¡ sá»Ÿ dá»¯ liá»‡u}

\begin{lstlisting}[caption=CÃ i MySQL vÃ  khá»Ÿi táº¡o database]
sudo apt install -y mysql-server
sudo systemctl enable --now mysql
sudo mysql_secure_installation

# Táº¡o DB vÃ  user (náº¿u dÃ¹ng user riÃªng)
sudo mysql <<'SQL'
CREATE DATABASE aivdb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'aivuser'@'localhost' IDENTIFIED BY 'yourStrongPass';
GRANT ALL PRIVILEGES ON aivdb.* TO 'aivuser'@'localhost';
FLUSH PRIVILEGES;
SQL
\end{lstlisting}

\subsection{CÃ i Adminer (tuá»³ chá»n) qua Nginx + PHP-FPM}

\begin{lstlisting}[caption=CÃ i Nginx, PHP-FPM vÃ  Adminer]
sudo apt install -y nginx php-fpm php-mysql
sudo mkdir -p /var/www/adminer && cd /var/www/adminer
sudo curl -L https://www.adminer.org/latest.php -o index.php
sudo chown -R www-data:www-data /var/www/adminer

# Táº¡o virtual host Nginx
sudo tee /etc/nginx/sites-available/adminer > /dev/null <<'NGINX'
server {
    listen 80;
    server_name _;
    root /var/www/adminer;
    index index.php;

    location / {
        try_files $uri /index.php?$args;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php-fpm.sock;
    }
}
NGINX

sudo ln -s /etc/nginx/sites-available/adminer /etc/nginx/sites-enabled/adminer
sudo nginx -t && sudo systemctl reload nginx
\end{lstlisting}

\subsection{Reverse proxy Nginx cho á»©ng dá»¥ng}

\begin{lstlisting}[caption=Reverse proxy tá»›i Next.js trÃªn cá»•ng 3000]
sudo tee /etc/nginx/sites-available/aiv-dashboard > /dev/null <<'NGINX'
server {
    listen 80;
    server_name your-domain.example.com;  # thay báº±ng domain tháº­t khi cÃ³

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://127.0.0.1:3000;
    }
}
NGINX

sudo ln -s /etc/nginx/sites-available/aiv-dashboard /etc/nginx/sites-enabled/aiv-dashboard
sudo nginx -t && sudo systemctl reload nginx
\end{lstlisting}

\subsection{SSL/TLS (tuá»³ chá»n theo domain)}

SSL Ã¡p dá»¥ng cho \textbf{domain}, khÃ´ng Ã¡p dá»¥ng cho Ä‘á»‹a chá»‰ IP. Khi Ä‘Ã£ trá» A record cá»§a domain vá» IP VPS, cÃ³ thá»ƒ dÃ¹ng Certbot Ä‘á»ƒ phÃ¡t hÃ nh chá»©ng chá»‰ Let's Encrypt:

\begin{lstlisting}[caption=CÃ i Certbot vÃ  cáº¥p chá»©ng chá»‰]
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.example.com

# Gia háº¡n tá»± Ä‘á»™ng (cron máº·c Ä‘á»‹nh Ä‘Ã£ táº¡o bá»Ÿi certbot)
sudo systemctl status certbot.timer
\end{lstlisting}

\subsection{Kiá»ƒm tra vÃ  váº­n hÃ nh}

\begin{lstlisting}[caption=CÃ¡c lá»‡nh váº­n hÃ nh thÆ°á»ng dÃ¹ng]
# á»¨ng dá»¥ng
pm2 status
pm2 logs aiv-dashboard --lines 100
pm2 restart aiv-dashboard

# Dá»‹ch vá»¥ há»‡ thá»‘ng
sudo systemctl status nginx
sudo systemctl status mysql

# Káº¿t ná»‘i HTTP
curl -I http://127.0.0.1:3000
\end{lstlisting}

\subsection{Sá»± cá»‘ phá»• biáº¿n vÃ  cÃ¡ch kháº¯c phá»¥c}

\begin{itemize}
  \item \textbf{Port 3000 báº­n (EADDRINUSE)}: tÃ¬m vÃ  dá»«ng tiáº¿n trÃ¬nh: \texttt{sudo lsof -i :3000}, \texttt{sudo kill -9 <PID>} vÃ  \texttt{pm2 restart}.
  \item \textbf{KhÃ´ng káº¿t ná»‘i MySQL}: kiá»ƒm tra biáº¿n mÃ´i trÆ°á»ng \texttt{DATABASE\_*}, thá»­ \texttt{mysql -u root -p}, kiá»ƒm tra \texttt{bind-address} trong \texttt{/etc/mysql/my.cnf} náº¿u cáº§n truy cáº­p tá»« xa.
  \item \textbf{SSH Permission denied (publickey)}: kiá»ƒm tra quyá»n \texttt{.ssh} (700) vÃ  \texttt{authorized\_keys} (600), Ä‘Ãºng user, Ä‘Ãºng key.
  \item \textbf{Certbot lá»—i DNS NXDOMAIN}: Ä‘áº£m báº£o A record cá»§a domain trá» vá» IP VPS trÆ°á»›c khi cáº¥p chá»©ng chá»‰.
\end{itemize}

\subsection{Trá» subdomain tá»« Vinahost Ä‘á»ƒ gá»i API backend}

Pháº§n nÃ y hÆ°á»›ng dáº«n trá» má»™t \textbf{subdomain} (vÃ­ dá»¥: \texttt{api.example.vn}) tá»« Vinahost vá» VPS Ä‘á»ƒ sá»­ dá»¥ng lÃ m endpoint API backend.

\subsubsection{BÆ°á»›c 1: Táº¡o DNS record táº¡i Vinahost}

\begin{itemize}
  \item ÄÄƒng nháº­p trang quáº£n trá»‹ DNS cá»§a Vinahost.
  \item Táº¡o \textbf{A record} cho subdomain trá» vá» IP VPS:
\end{itemize}

\begin{lstlisting}[caption=Tham chiáº¿u cáº¥u hÃ¬nh DNS (Vinahost), language=bash]
Type:   A
Host:   api            # nghÄ©a lÃ  api.example.vn
Value:  103.110.85.200 # IP VPS cá»§a báº¡n
TTL:    300            # 5 phÃºt (tuá»³ chá»n)
\end{lstlisting}

LÆ°u Ã½: DNS propagation cÃ³ thá»ƒ máº¥t vÃ i phÃºt Ä‘áº¿n 1 giá». Kiá»ƒm tra báº±ng:

\begin{lstlisting}[caption=Kiá»ƒm tra phÃ¢n giáº£i DNS]
dig +short A api.example.vn
\end{lstlisting}

\subsubsection{BÆ°á»›c 2: Cáº­p nháº­t Nginx \texttt{server\_name} cho API}

Náº¿u API backend chia sáº» cÃ¹ng process Next.js, cÃ³ thá»ƒ dÃ¹ng chung reverse proxy. Náº¿u tÃ¡ch route API dÆ°á»›i \texttt{/api}, chá»‰ cáº§n thÃªm \texttt{server\_name} vÃ o virtual host hiá»‡n cÃ³:

\begin{lstlisting}[caption=ThÃªm server_name cho subdomain API]
sudo tee /etc/nginx/sites-available/aiv-dashboard > /dev/null <<'NGINX'
server {
    listen 80;
    server_name api.example.vn;  # thÃªm subdomain API

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://127.0.0.1:3000;
    }
}
NGINX

sudo nginx -t && sudo systemctl reload nginx
\end{lstlisting}

\subsubsection{BÆ°á»›c 3: Cáº¥p SSL (khuyáº¿n nghá»‹)}

\begin{lstlisting}[caption=Cáº¥p chá»©ng chá»‰ Let's Encrypt cho subdomain API]
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d api.example.vn
\end{lstlisting}

Sau khi cÃ i SSL, Nginx sáº½ tá»± redirect HTTPâ†’HTTPS (náº¿u chá»n). XÃ¡c minh:

\begin{lstlisting}
curl -I https://api.example.vn/api/health
\end{lstlisting}

\subsubsection{BÆ°á»›c 4: Cáº­p nháº­t biáº¿n mÃ´i trÆ°á»ng vÃ  CORS}

Náº¿u frontend hoáº·c client khÃ¡c gá»i API qua subdomain má»›i, cáº­p nháº­t biáº¿n mÃ´i trÆ°á»ng vÃ  allowlist CORS:

\begin{lstlisting}[caption=Cáº­p nháº­t .env trÃªn server]
BACKEND_HOST=https://api.example.vn
NEXT_PUBLIC_API_BASE=https://api.example.vn
ALLOWED_ORIGINS=https://www.example.vn,https://app.example.vn,https://api.example.vn,http://localhost:3000
\end{lstlisting}

VÃ­ dá»¥ cáº­p nháº­t allowlist trong \texttt{src/middleware.ts} hoáº·c cÃ¡c route API public:

\begin{lstlisting}[language=diff,caption=Bá»• sung origin má»›i]
@@
 const ALLOWED = new Set([
   "https://www.aiesec.vn",
   "https://aiv-dashboard-ten.vercel.app",
   "https://api.example.vn",   // thÃªm subdomain API
   "http://localhost:3000",
 ]);
\end{lstlisting}

Khá»Ÿi Ä‘á»™ng láº¡i á»©ng dá»¥ng:

\begin{lstlisting}
pm2 restart aiv-dashboard --update-env
\end{lstlisting}

\subsubsection{BÆ°á»›c 5: Kiá»ƒm thá»­ end-to-end}

\begin{lstlisting}[caption=Kiá»ƒm thá»­]
# DNS
dig +short A api.example.vn

# HTTP/HTTPS
curl -I https://api.example.vn
curl -I https://api.example.vn/api/health

# Tá»« frontend (browser devtools):
// fetch('https://api.example.vn/api/health').then(r => r.status)
\end{lstlisting}

\section{Tá»•ng quan vá» CI/CD}

Continuous Integration/Continuous Deployment (CI/CD) lÃ  má»™t phÆ°Æ¡ng phÃ¡p phÃ¡t triá»ƒn pháº§n má»m hiá»‡n Ä‘áº¡i, cho phÃ©p tá»± Ä‘á»™ng hÃ³a quÃ¡ trÃ¬nh tÃ­ch há»£p, kiá»ƒm thá»­ vÃ  triá»ƒn khai á»©ng dá»¥ng. Trong dá»± Ã¡n AIESEC Dashboard, tÃ´i Ä‘Ã£ triá»ƒn khai má»™t há»‡ thá»‘ng CI/CD sá»­ dá»¥ng GitHub Webhook Ä‘á»ƒ tá»± Ä‘á»™ng deploy á»©ng dá»¥ng má»—i khi cÃ³ thay Ä‘á»•i code.

\subsection{Äá»‹nh nghÄ©a vÃ  má»¥c tiÃªu}

CI/CD bao gá»“m hai khÃ¡i niá»‡m chÃ­nh:
\begin{itemize}
    \item \textbf{Continuous Integration (CI)}: TÃ­ch há»£p liÃªn tá»¥c code tá»« nhiá»u developer vÃ o má»™t repository chung
    \item \textbf{Continuous Deployment (CD)}: Triá»ƒn khai liÃªn tá»¥c code Ä‘Ã£ Ä‘Æ°á»£c tÃ­ch há»£p vÃ o mÃ´i trÆ°á»ng production
\end{itemize}

Má»¥c tiÃªu chÃ­nh cá»§a viá»‡c triá»ƒn khai CI/CD:
\begin{itemize}
    \item Tá»± Ä‘á»™ng hÃ³a quy trÃ¬nh deploy
    \item Giáº£m thiá»ƒu lá»—i human error
    \item TÄƒng tá»‘c Ä‘á»™ phÃ¡t triá»ƒn vÃ  triá»ƒn khai
    \item Äáº£m báº£o tÃ­nh á»•n Ä‘á»‹nh cá»§a há»‡ thá»‘ng
\end{itemize}

\section{Kiáº¿n trÃºc há»‡ thá»‘ng CI/CD}

\subsection{MÃ´ hÃ¬nh hoáº¡t Ä‘á»™ng}

Há»‡ thá»‘ng CI/CD Ä‘Æ°á»£c thiáº¿t káº¿ theo mÃ´ hÃ¬nh Ä‘Æ¡n giáº£n nhÆ°ng hiá»‡u quáº£:

\begin{center}
\texttt{Developer â†’ GitHub Repository â†’ Webhook Server â†’ Production Server}
\end{center}

\subsubsection{Quy trÃ¬nh hoáº¡t Ä‘á»™ng chi tiáº¿t}

\begin{enumerate}
    \item \textbf{Development Phase}: Developer thá»±c hiá»‡n commit vÃ  push code lÃªn GitHub repository
    \item \textbf{Webhook Trigger}: GitHub tá»± Ä‘á»™ng gá»­i POST request Ä‘áº¿n webhook server
    \item \textbf{Webhook Processing}: Webhook server nháº­n request vÃ  validate
    \item \textbf{Deployment Execution}: Script deploy Ä‘Æ°á»£c thá»±c thi tá»± Ä‘á»™ng
    \item \textbf{Application Restart}: PM2 restart á»©ng dá»¥ng vá»›i version má»›i
\end{enumerate}

\subsection{CÃ¡c thÃ nh pháº§n chÃ­nh}

\subsubsection{GitHub Webhook}
\begin{itemize}
    \item \textbf{URL}: \texttt{https://aiv-dashboard-ten.vercel.app/hooks/aiv-dashboard-deploy}
    \item \textbf{Event}: Push to main branch
    \item \textbf{Content-Type}: application/json
    \item \textbf{Security}: IP whitelist cho GitHub servers
\end{itemize}

\subsubsection{Webhook Service}
\begin{itemize}
    \item \textbf{Port}: 9000
    \item \textbf{Configuration}: \texttt{/etc/webhook/hooks.json}
    \item \textbf{Service Management}: systemd service
    \item \textbf{Auto-restart}: Enabled vá»›i restart policy
\end{itemize}

\subsubsection{Deployment Script}
\begin{itemize}
    \item \textbf{Path}: \texttt{/root/apps/aiv-dashboard/deploy.sh}
    \item \textbf{Functionality}: Pull code, install dependencies, build, restart
    \item \textbf{Working Directory}: \texttt{/root/apps/aiv-dashboard}
\end{itemize}

\section{Triá»ƒn khai vÃ  cáº¥u hÃ¬nh}

\subsection{CÃ i Ä‘áº·t Webhook Service}

\begin{lstlisting}[caption=CÃ i Ä‘áº·t webhook package]
# CÃ i Ä‘áº·t webhook package
sudo apt update
sudo apt install webhook

# Táº¡o thÆ° má»¥c cáº¥u hÃ¬nh
sudo mkdir -p /etc/webhook
\end{lstlisting}

\subsection{Cáº¥u hÃ¬nh Webhook}

File cáº¥u hÃ¬nh \texttt{/etc/webhook/hooks.json}:

\begin{lstlisting}[caption=Cáº¥u hÃ¬nh webhook hooks.json, language=json]
[
  {
    "id": "aiv-dashboard-deploy",
    "execute-command": "/root/apps/aiv-dashboard/deploy.sh",
    "command-working-directory": "/root/apps/aiv-dashboard",
    "response-message": "Deployment started successfully!"
  }
]
\end{lstlisting}

\subsection{Script Deployment}

Script \texttt{/root/apps/aiv-dashboard/deploy.sh}:

\begin{lstlisting}[caption=Script deployment tá»± Ä‘á»™ng]
#!/bin/bash

echo "ğŸš€ Starting deployment at $(date)"

# Pull latest code
echo "ğŸ“¥ Pulling latest code..."
git pull origin main

# Install dependencies
echo "ğŸ“¦ Installing dependencies..."
npm ci

# Build application
echo "ğŸ”¨ Building application..."
npm run build

# Restart PM2
echo "ğŸ”„ Restarting application..."
pm2 restart aiv-dashboard

# Check status
echo "âœ… Checking status..."
pm2 status

echo "ğŸ‰ Deployment completed at $(date)"
\end{lstlisting}

\subsection{Systemd Service Configuration}

File \texttt{/etc/systemd/system/webhook.service}:

\begin{lstlisting}[caption=Cáº¥u hÃ¬nh systemd service]
[Unit]
Description=Webhook Service for Auto Deploy
After=network.target
Wants=network.target

[Service]
Type=simple
User=root
Group=root
ExecStart=/usr/bin/webhook -hooks /etc/webhook/hooks.json -verbose -port 9000
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
\end{lstlisting}

\section{Káº¿t quáº£ triá»ƒn khai}

\subsection{Lá»£i Ã­ch Ä‘áº¡t Ä‘Æ°á»£c}

\subsubsection{Tá»± Ä‘á»™ng hÃ³a hoÃ n toÃ n}
\begin{itemize}
    \item Loáº¡i bá» viá»‡c deploy thá»§ cÃ´ng
    \item Giáº£m thiá»ƒu lá»—i human error
    \item TÄƒng tá»‘c Ä‘á»™ triá»ƒn khai
\end{itemize}

\subsubsection{TÃ­nh kháº£ dá»¥ng cao}
\begin{itemize}
    \item Auto-restart khi service crash
    \item Monitoring vÃ  logging Ä‘áº§y Ä‘á»§
    \item Rollback nhanh chÃ³ng khi cáº§n
\end{itemize}

\subsubsection{Báº£o máº­t}
\begin{itemize}
    \item Chá»‰ deploy tá»« GitHub repository Ä‘Æ°á»£c á»§y quyá»n
    \item IP whitelist cho GitHub servers
    \item Audit trail Ä‘áº§y Ä‘á»§
\end{itemize}

\subsection{Metrics vÃ  hiá»‡u suáº¥t}

\subsubsection{Thá»i gian deploy}
\begin{itemize}
    \item \textbf{TrÆ°á»›c khi triá»ƒn khai CI/CD}: 5-10 phÃºt (thá»§ cÃ´ng)
    \item \textbf{Sau khi triá»ƒn khai}: 30-60 giÃ¢y (tá»± Ä‘á»™ng)
\end{itemize}

\subsubsection{Táº§n suáº¥t deploy}
\begin{itemize}
    \item TÄƒng tá»« 1-2 láº§n/tuáº§n lÃªn 5-10 láº§n/tuáº§n
    \item Kháº£ nÄƒng deploy hotfix ngay láº­p tá»©c
\end{itemize}

\subsubsection{Uptime}
\begin{itemize}
    \item 99.9\% uptime nhá» auto-restart
    \item Zero-downtime deployment
\end{itemize}

\section{Monitoring vÃ  Troubleshooting}

\subsection{Logging System}

\begin{lstlisting}[caption=CÃ¡c lá»‡nh monitoring]
# Webhook logs
sudo journalctl -u webhook -f

# Application logs
pm2 logs aiv-dashboard

# System status
pm2 status
sudo systemctl status webhook
\end{lstlisting}

\subsection{Health Checks}

\begin{lstlisting}[caption=CÃ¡c lá»‡nh health check]
# Check webhook endpoint
curl http://localhost:9000/hooks/aiv-dashboard-deploy

# Check application health
curl http://localhost:3000/api/health

# Check system resources
htop
df -h
\end{lstlisting}

\section{Cáº­p nháº­t URL há»‡ thá»‘ng: Chuyá»ƒn tá»« IP sang Vercel Domain}

\subsection{Bá»‘i cáº£nh vÃ  má»¥c tiÃªu}

Trong giai Ä‘oáº¡n Ä‘áº§u, á»©ng dá»¥ng Ä‘Æ°á»£c truy cáº­p thÃ´ng qua IP \texttt{http://103.110.85.200:3000} nháº±m phá»¥c vá»¥ má»¥c Ä‘Ã­ch kiá»ƒm thá»­ nhanh. Sau khi á»•n Ä‘á»‹nh, yÃªu cáº§u lÃ  chuyá»ƒn toÃ n bá»™ endpoint vÃ  tracking URL vá» domain Vercel chÃ­nh thá»©c \href{https://aiv-dashboard-ten.vercel.app}{aiv-dashboard-ten.vercel.app} \cite{vercel-app}, Ä‘áº£m báº£o:
\begin{itemize}
  \item CORS cho phÃ©p tá»« domain má»›i (HTTPS)
  \item CÃ¡c API phÃ¡t sinh tracking link dÃ¹ng Ä‘Ãºng host má»›i
  \item Biáº¿n mÃ´i trÆ°á»ng vÃ  dá»¯ liá»‡u trong cÆ¡ sá»Ÿ dá»¯ liá»‡u Ä‘Æ°á»£c Ä‘á»“ng bá»™
  \item CÃ³ káº¿ hoáº¡ch rollback an toÃ n
\end{itemize}

\subsection{CÃ¡c thay Ä‘á»•i mÃ£ nguá»“n}

\subsubsection{Cáº­p nháº­t CORS trong middleware}
\texttt{src/middleware.ts} â€“ thÃªm Vercel domain vÃ o allowlist, thay cho IP:
\begin{lstlisting}[language=diff,caption=Update ALLOWED origins trong middleware.ts]
@@
 const ALLOWED = new Set([
-  "https://www.aiesec.vn",
-  "http://103.110.85.200:3000",
-  "http://localhost:3000",
+  "https://www.aiesec.vn",
+  "https://aiv-dashboard-ten.vercel.app",
+  "http://localhost:3000",
 ]);
\end{lstlisting}

\subsubsection{Cáº­p nháº­t host khi táº¡o tracking link}
\texttt{src/app/api/utm/links/route.ts} â€“ Ä‘áº·t fallback host vá» Vercel domain thay vÃ¬ IP:
\begin{lstlisting}[language=diff,caption=Update generateTrackingLink]
@@
-const baseUrl = process.env.BACKEND_HOST || process.env.NEXT_PUBLIC_APP_URL || 'http://103.110.85.200:3000';
+const baseUrl = process.env.BACKEND_HOST || process.env.NEXT_PUBLIC_APP_URL || 'https://aiv-dashboard-ten.vercel.app';
\end{lstlisting}

\subsubsection{Äá»“ng bá»™ CORS á»Ÿ public submit endpoint}
\texttt{src/app/api/forms/by-code/[code]/submit/route.ts} â€“ cáº­p nháº­t \texttt{ALLOWED\_ORIGINS}:
\begin{lstlisting}[language=diff,caption=Update ALLOWED_ORIGINS cho submit route]
@@
- (process.env.ALLOWED_ORIGINS || "https://www.aiesec.vn,http://103.110.85.200:3000,http://localhost:3000")
+ (process.env.ALLOWED_ORIGINS || "https://www.aiesec.vn,https://aiv-dashboard-ten.vercel.app,http://localhost:3000")
\end{lstlisting}

\subsection{Cáº­p nháº­t biáº¿n mÃ´i trÆ°á»ng}

TrÃªn mÃ¡y chá»§ (PM2), cáº­p nháº­t file \texttt{.env} vÃ  khá»Ÿi Ä‘á»™ng láº¡i á»©ng dá»¥ng:
\begin{lstlisting}[caption=Cáº­p nháº­t .env]
ALLOWED_ORIGINS=https://www.aiesec.vn,https://aiv-dashboard-ten.vercel.app,http://localhost:3000
BACKEND_HOST=https://aiv-dashboard-ten.vercel.app
NEXT_PUBLIC_APP_URL=https://aiv-dashboard-ten.vercel.app
\end{lstlisting}

\begin{lstlisting}[caption=Restart á»©ng dá»¥ng]
pm2 restart aiv-dashboard
pm2 logs aiv-dashboard --lines 50
\end{lstlisting}

\subsection{Cáº­p nháº­t dá»¯ liá»‡u trong cÆ¡ sá»Ÿ dá»¯ liá»‡u}

Chuáº©n hÃ³a cÃ¡c tracking URL Ä‘Ã£ táº¡o trÆ°á»›c Ä‘Ã³ Ä‘á»ƒ trá» vá» domain má»›i (MySQL):
\begin{lstlisting}[language=sql,caption=Chuáº©n hÃ³a tracking_link vá» domain Vercel]
UPDATE utm_links 
SET tracking_link = REPLACE(tracking_link, 'http://103.110.85.200:3000', 'https://aiv-dashboard-ten.vercel.app')
WHERE tracking_link LIKE '%103.110.85.200:3000%';

UPDATE utm_links 
SET tracking_link = REPLACE(tracking_link, 'http://aiesecvn.digital.com:3000', 'https://aiv-dashboard-ten.vercel.app')
WHERE tracking_link LIKE '%aiesecvn.digital.com:3000%';
\end{lstlisting}

\subsection{Kiá»ƒm thá»­ vÃ  xÃ¡c minh}

\begin{itemize}
  \item Kiá»ƒm tra API test:
\begin{lstlisting}
curl https://aiv-dashboard-ten.vercel.app/api/test
\end{lstlisting}
  \item Kiá»ƒm tra CORS tá»« trang Webflow/Client: forms submit thÃ nh cÃ´ng, khÃ´ng lá»—i preflight
  \item Táº¡o UTM link má»›i vÃ  xÃ¡c nháº­n \texttt{tracking\_link} dÃ¹ng Ä‘Ãºng domain HTTPS
  \item Kiá»ƒm tra log á»©ng dá»¥ng qua PM2 Ä‘áº£m báº£o khÃ´ng cÃ³ lá»—i 4xx/5xx báº¥t thÆ°á»ng
\end{itemize}

\subsection{Rá»§i ro vÃ  káº¿ hoáº¡ch rollback}

\begin{itemize}
  \item \textbf{Rá»§i ro CORS}: origin khÃ´ng náº±m trong allowlist \Rightarrow lá»—i preflight. Kháº¯c phá»¥c: bá»• sung domain vÃ o \texttt{ALLOWED}/\texttt{ALLOWED\_ORIGINS}
  \item \textbf{Rá»§i ro data mismatch}: cÃ¡c \texttt{tracking\_link} cÅ© khÃ´ng Ä‘Æ°á»£c chuáº©n hÃ³a \Rightarrow redirect sai host. Kháº¯c phá»¥c: cháº¡y script SQL trÃªn
  \item \textbf{Rollback}: khÃ´i phá»¥c \texttt{.env} cÅ© vÃ  revert code thay Ä‘á»•i host vá» IP, \texttt{pm2 restart}
\end{itemize}

\subsection{Káº¿t quáº£}

Sau thay Ä‘á»•i:
\begin{itemize}
  \item Táº¥t cáº£ request sá»­ dá»¥ng HTTPS trÃªn domain Vercel, tÆ°Æ¡ng thÃ­ch vá»›i Clipboard API vÃ  cÃ¡c chÃ­nh sÃ¡ch báº£o máº­t trÃ¬nh duyá»‡t
  \item CORS cáº¥u hÃ¬nh Ä‘Ãºng cho domain má»›i, khÃ´ng cÃ²n phá»¥ thuá»™c IP
  \item Há»‡ thá»‘ng tracking link Ä‘á»“ng bá»™ vÃ  nháº¥t quÃ¡n, giáº£m rá»§i ro khi thay Ä‘á»•i háº¡ táº§ng
\end{itemize}

\begin{thebibliography}{9}
\bibitem{vercel-app} AIESEC Dashboard (Vercel). Truy cáº­p: \href{https://aiv-dashboard-ten.vercel.app}{https://aiv-dashboard-ten.vercel.app}
\end{thebibliography}

\section{Káº¿t luáº­n}

Viá»‡c triá»ƒn khai há»‡ thá»‘ng CI/CD Ä‘Ã£ mang láº¡i nhá»¯ng lá»£i Ã­ch Ä‘Ã¡ng ká»ƒ:

\begin{enumerate}
    \item \textbf{TÄƒng hiá»‡u quáº£ phÃ¡t triá»ƒn}: Developer cÃ³ thá»ƒ focus vÃ o coding thay vÃ¬ deploy
    \item \textbf{Giáº£m thiá»ƒu rá»§i ro}: Tá»± Ä‘á»™ng hÃ³a giáº£m lá»—i human error
    \item \textbf{TÄƒng tÃ­nh á»•n Ä‘á»‹nh}: Auto-restart vÃ  monitoring Ä‘áº£m báº£o service luÃ´n available
    \item \textbf{Cáº£i thiá»‡n tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng}: Deploy nhanh hÆ¡n, Ã­t downtime
\end{enumerate}

Há»‡ thá»‘ng CI/CD nÃ y Ä‘Ã£ chá»©ng minh tÃ­nh hiá»‡u quáº£ trong viá»‡c quáº£n lÃ½ vÃ  triá»ƒn khai á»©ng dá»¥ng AIESEC Dashboard, táº¡o ná»n táº£ng vá»¯ng cháº¯c cho viá»‡c phÃ¡t triá»ƒn vÃ  má»Ÿ rá»™ng há»‡ thá»‘ng trong tÆ°Æ¡ng lai.

\subsection{Khuyáº¿n nghá»‹ phÃ¡t triá»ƒn}

Äá»ƒ cáº£i thiá»‡n thÃªm há»‡ thá»‘ng CI/CD trong tÆ°Æ¡ng lai:

\begin{itemize}
    \item Triá»ƒn khai automated testing trÆ°á»›c khi deploy
    \item ThÃªm notification system (Slack, Email) khi deploy
    \item Implement blue-green deployment Ä‘á»ƒ giáº£m downtime
    \item ThÃªm database migration automation
    \item Setup monitoring vÃ  alerting system
\end{itemize}

\end{document}
