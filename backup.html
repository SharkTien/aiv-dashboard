<script src="https://code.jquery.com/jquery-2.1.4.js"></script>
<script src="//cdn.jsdelivr.net/jquery.scrollto/2.1.2/jquery.scrollTo.min.js"></script>
<script>window.WEBFLOW_API_HOST='https://aiv-dashboard-ten.vercel.app';</script>
<style>
.selectize-input {
border: none !important;
}
</style>
<script>
/*

async function postData(url = "", data) {
        try {
            const response = await fetch(url, {
                method: "POST",
                mode: "cors",
                cache: "default",
                headers: {
                    "Content-Type": "application/json",
                },
                redirect: "follow",
                referrerPolicy: "no-referrer",
                body: JSON.stringify(data),
            });
            
            return response.json();
        } catch (error) {
            console.error(error);
            throw new Error("Failed to fetch data");
        }
    }

    const API = "https://tmrwinter2023-production.up.railway.app/ingest";

    const form = document.forms["wf-form-Tmr-Fall-2025"];
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const waitingblock = document.getElementById("waitingblock");
        waitingblock.style.display = "block";
        form.style.display = "none";
        
        document.getElementById('TMR--form--header').scrollIntoView();
        
        const today = new Date();
        const dateTime = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate() +
            ' ' + today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
        
        document.getElementById("timestamp").value = dateTime;
        document.getElementById("form-submit-tmr").value = "Your application is being submitted. Please wait...";
        
        const formData = new FormData(form);
        const dataObject = {};
        
	for (const pair of formData.entries()) {
            dataObject[pair[0]] = pair[1];
        }
        
        try {
            const data = await postData(API, dataObject);
            console.log(data);
            
            const success = document.getElementById("customSuccess");
            success.style.display = "block";
            waitingblock.style.display = "none";
        } catch (error) {
            alert("An error occurred. Please try again.");
            var error = document.getElementById("customError");
            document.getElementById("form-submit-tmr").value = "Submit";
            error.style.display = "block";
            waitingblock.style.display = "none";
        }
    });
*/
const form = document.forms['wf-form-Tmr-Fall-2025'];
const TARGET_FORM_CODE = 'tmr-f25-submissions-1757061730860';

async function POSTFORM() {
    try {
        const formData = new FormData(form);
        const response = await fetch(form.action, { // Gửi trực tiếp lên Webflow
            method: 'POST',
            body: formData,
        });

        if (!response.ok) throw new Error('Network response was not ok');

        console.log('Form submitted successfully');
        form.style.display = "none";
        document.getElementById('customSuccess').style.display = "block";
        document.getElementById('TMR--form--header').scrollIntoView();
    } catch (error) {
        //console.error('Error submitting form:', error);
        form.style.display = "none";
        console.log('Form submitted successfully');
        document.getElementById('customSuccess').style.display = "block";
        document.getElementById('TMR--form--header').scrollIntoView();
        //document.getElementById('customError').style.display = "block";
    }
}

function resolveApiHost() {
  try {
    if (typeof window !== "undefined" && window.WEBFLOW_API_HOST) {
      return window.WEBFLOW_API_HOST;
    }
    const fromAttr = form && (form.getAttribute('data-api-host') || (form.dataset ? form.dataset.apiHost : ''));
    const inputEl = form && form.querySelector('input[name="api-host"]');
    const fromInput = inputEl && inputEl.value ? inputEl.value : '';
    const origin = (typeof window !== 'undefined' ? window.location.origin : '');
    return fromAttr || fromInput || origin;
  } catch {
    return (typeof window !== 'undefined' ? window.location.origin : '');
  }
}


function toObject(formData) {
  const out = {};
  formData.forEach((value, key) => {
    if (Object.prototype.hasOwnProperty.call(out, key)) {
      const existing = out[key];
      out[key] = Array.isArray(existing) ? [...existing, value] : [existing, value];
    } else {
      out[key] = value;
    }
  });
  return out;
}


async function submitToBackend(formData) {
  const payload = toObject(formData);

  // Normalize datetime
  for (const [key, val] of Object.entries(payload)) {
    if (val && typeof val === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(val)) {
      const dt = new Date(val);
      if (!isNaN(dt.getTime())) payload[key] = dt.toISOString();
    }
  }

  try {
    const API_HOST = resolveApiHost();
    const url = `${API_HOST}/api/forms/by-code/${TARGET_FORM_CODE}/submit`;

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`Submit failed: ${res.status} ${txt}`);
    }

    return true;
  } catch (e) {
    console.error("DB error:", e);
    return false;
  }
}

form.addEventListener('submit', async e => {
    e.preventDefault();
    document.getElementById('form-submit-tmr').value = "Đơn đăng ký của bạn đang được gửi đi";
    document.getElementById('form-submit-tmr').disabled = true;
    await POSTFORM();

    form.setAttribute('data-form-code', TARGET_FORM_CODE);

    const formData = new FormData(form);
    await submitToBackend(formData); 
});

</script>